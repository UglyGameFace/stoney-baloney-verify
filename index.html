<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#050505" />
  <title>Stoney Baloney Verify</title>

  <link href="https://fonts.googleapis.com/css2?family=Rubik+Glitch&family=Fredoka:wght@400;600&family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>

  <style>
    :root {
      --neon-green: #39ff14;
      --neon-red: #ff3333;
      --neon-orange: #ffaa00;
      --neon-purple: #bc13fe;
      --deep-space: #050505;
      --grid-color: rgba(57, 255, 20, 0.15);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

    body {
      background-color: var(--deep-space); color: #fff; font-family: 'Fredoka', sans-serif;
      min-height: 100dvh; display: flex; flex-direction: column; overflow-x: hidden; position: relative;
      touch-action: none;
    }

    .trippy-bg { position: fixed; top: 0; left: 0; width: 200%; height: 200%; background: radial-gradient(circle, #1a0b2e 10%, #000000 90%); z-index: -3; animation: breathe 10s infinite alternate; }
    .grid-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px); background-size: 40px 40px; perspective: 500px; z-index: -2; opacity: 0.5; mask-image: radial-gradient(circle, black 40%, transparent 80%); }
    .scanlines { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)); background-size: 100% 2px, 3px 100%; pointer-events: none; z-index: 999; }

    .app-container { flex: 1; display: flex; flex-direction: column; width: 100%; max-width: 500px; margin: 0 auto; padding: 15px; z-index: 10; position: relative; }
    .header { text-align: center; margin-bottom: 10px; margin-top: 10px; }
    .logo-icon { font-size: 50px; color: var(--neon-green); filter: drop-shadow(0 0 15px var(--neon-green)); animation: float 3s ease-in-out infinite; }
    .brand-name { font-family: 'Rubik Glitch', cursive; font-size: 32px; color: #fff; text-shadow: 2px 2px 0px var(--neon-purple); margin-top: 5px; line-height: 1; }
    .chill-text { font-family:'Share Tech Mono'; color:#777; margin-top:6px; font-size:12px; }

    .btn {
      background: linear-gradient(45deg, var(--neon-green), #006400); color: #000; width: 100%;
      padding: 16px; border: none; border-radius: 4px; font-size: 20px; font-weight: 800;
      font-family: 'Rubik Glitch', sans-serif; letter-spacing: 2px; text-transform: uppercase; cursor: pointer;
      box-shadow: 0 0 15px rgba(57, 255, 20, 0.4); margin-bottom: 10px;
      clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
    }
    .btn:active { transform: scale(0.98); background: var(--neon-green); }
    .btn:disabled { opacity: 0.45; cursor: not-allowed; filter: grayscale(0.3); }

    .screen { display: none; flex-direction: column; flex: 1; height: 100%; }
    .screen.active { display: flex; animation: fade-in 0.4s ease; }
    @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes breathe { 0% { transform: scale(1); } 100% { transform: scale(1.1); } }
    @keyframes float { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
    .option { background: rgba(0,0,0,0.4); border: 2px solid #333; border-radius: 10px; padding: 25px 10px; text-align: center; transition: 0.2s; user-select:none; }
    .option:active { border-color: var(--neon-green); background: rgba(57, 255, 20, 0.15); box-shadow: 0 0 15px var(--neon-green); }
    .option i { font-size: 32px; color: #fff; margin-bottom: 10px; }
    .feature-row { display: flex; align-items: center; margin-bottom: 15px; }
    .feature-row i { font-size: 20px; color: var(--neon-purple); margin-right: 15px; width: 25px; text-align: center; }

    #editor-wrapper {
      flex: 1; position: relative; background: #000; border: 2px solid var(--neon-green);
      border-radius: 10px; overflow: hidden; margin-bottom: 10px; box-shadow: 0 0 20px rgba(57, 255, 20, 0.1);
    }
    canvas { display: block; width: 100%; height: 100%; touch-action: none; }

    .toolbar-main { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-bottom: 10px; }
    .tool-btn {
      background: rgba(20, 20, 20, 0.9); border: 1px solid #444; color: #fff;
      padding: 10px 5px; border-radius: 6px; font-family: 'Share Tech Mono'; font-size: 10px;
      text-align: center; display: flex; flex-direction: column; align-items: center; gap: 5px; cursor:pointer;
      user-select:none;
    }
    .tool-btn i { font-size: 16px; color: var(--neon-green); }
    .tool-btn.active { border-color: var(--neon-green); background: rgba(57, 255, 20, 0.15); }
    .tool-btn:active { background: #444; }

    .zoom-controls { position: absolute; bottom: 15px; right: 15px; display: flex; flex-direction: column; gap: 8px; }
    .zoom-circle {
      width: 40px; height: 40px; border-radius: 50%; background: rgba(0,0,0,0.8);
      border: 2px solid var(--neon-green); color: var(--neon-green); font-size: 18px;
      display: flex; align-items: center; justify-content: center; cursor:pointer;
    }

    #tutorial-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.85); z-index: 500; display: none; justify-content: center; align-items: center;
      flex-direction: column; text-align: center; backdrop-filter: blur(5px);
    }
    .tut-card { background: #111; border: 1px solid var(--neon-green); padding: 25px; border-radius: 15px; width: 85%; box-shadow: 0 0 30px rgba(57, 255, 20, 0.2); }
    .tut-row { display: flex; align-items: center; margin-bottom: 20px; text-align: left; }
    .tut-icon { font-size: 30px; width: 50px; text-align: center; margin-right: 15px; }

    #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; display: none; justify-content: center; align-items: center; flex-direction: column; }
    .loading-text { font-family: 'Rubik Glitch'; color: var(--neon-green); font-size: 24px; margin-top: 20px; text-align:center; }
    .scanner-beam { width: 250px; height: 2px; background: var(--neon-green); animation: scan-beam 1.5s infinite linear; box-shadow: 0 0 10px var(--neon-green); }
    @keyframes scan-beam { 0% { transform: translateY(-50px); opacity:0; } 50% { opacity:1; } 100% { transform: translateY(50px); opacity:0; } }

    #manual-options { display: none; width: 80%; text-align: center; margin-top: 20px; }
    .btn-manual { background: transparent; border: 1px solid var(--neon-orange); color: var(--neon-orange); padding: 10px; width: 100%; margin-top: 10px; font-weight:bold; cursor:pointer;}

    .token-warning {
      background: rgba(255, 51, 51, 0.1);
      border: 1px solid rgba(255, 51, 51, 0.4);
      color: #ffb3b3;
      padding: 10px;
      border-radius: 10px;
      font-family: "Share Tech Mono";
      font-size: 12px;
      line-height: 1.4;
      margin: 10px 0 0 0;
      display: none;
    }

    /* ‚úÖ NEW: modal */
    #modal-overlay{
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.88);
      z-index: 3000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      backdrop-filter: blur(5px);
    }
    .modal {
      width: 100%;
      max-width: 520px;
      background: #0b0b0b;
      border: 1px solid rgba(57,255,20,0.35);
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 0 28px rgba(57,255,20,0.14);
    }
    .modal h3{
      font-family: 'Rubik Glitch';
      letter-spacing: 1px;
      font-size: 22px;
      margin-bottom: 8px;
      color: #fff;
    }
    .modal p{
      font-family: 'Share Tech Mono';
      color: #bdbdbd;
      font-size: 13px;
      line-height: 1.45;
    }
    .modal .pill{
      display:inline-block;
      margin-top:10px;
      font-family: 'Share Tech Mono';
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,170,0,0.45);
      color: var(--neon-orange);
      background: rgba(255,170,0,0.08);
    }
    .modal-actions{
      margin-top: 14px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .btn-secondary{
      background: transparent;
      border: 1px solid rgba(57,255,20,0.35);
      color: var(--neon-green);
      font-family: 'Share Tech Mono';
      letter-spacing: 0;
      text-transform: none;
      clip-path: none;
    }
    .btn-danger{
      background: transparent;
      border: 1px solid rgba(255,51,51,0.45);
      color: #ffb3b3;
      font-family: 'Share Tech Mono';
      letter-spacing: 0;
      text-transform: none;
      clip-path: none;
    }
  </style>
</head>

<body>
  <div class="scanlines"></div>
  <div class="trippy-bg"></div>
  <div class="grid-bg"></div>

  <!-- ‚úÖ NEW MODAL -->
  <div id="modal-overlay">
    <div class="modal">
      <h3 id="modal-title">‚ö†Ô∏è Possible Non-ID Image</h3>
      <p id="modal-text">
        This photo doesn‚Äôt look like an ID card. Please retake the photo with the ID filling the frame,
        in good lighting, with the text readable.
      </p>
      <div class="pill" id="modal-reason">Reason: NOT_DETECTED</div>
      <div class="modal-actions">
        <button class="btn btn-danger" onclick="modalRetake()">Retake Photo</button>
        <button class="btn btn-secondary" onclick="modalContinue()">Continue Anyway</button>
      </div>
    </div>
  </div>

  <div id="loading-overlay">
    <i class="fas fa-eye" style="font-size: 50px; color: #333;"></i>
    <div class="scanner-beam"></div>
    <div class="loading-text" id="loading-msg">ANALYZING...</div>
    <div id="manual-options">
      <button class="btn btn-manual" onclick="forceEditor()">SKIP AI CHECK</button>
    </div>
  </div>

  <div class="app-container">
    <div id="screen-landing" class="screen active">
      <div class="header">
        <i class="fas fa-cannabis logo-icon"></i>
        <div class="brand-name">STONEY<br>BALONEY</div>
        <div class="chill-text">// SECURE_VERIFY_V6</div>

        <div id="tokenWarning" class="token-warning">
          ‚ö†Ô∏è Missing <b>?token=</b> in the link.<br/>
          This page must be opened from the Discord ticket verification link.
        </div>
      </div>

      <div style="flex:1; display:flex; align-items:center;">
        <div class="card" style="width:100%;">
          <div class="feature-row">
            <i class="fas fa-search"></i>
            <div>
              <h3 style="color:var(--neon-green);">Smart Scan</h3>
              <p style="color:#aaa;">Auto-detects face area.</p>
            </div>
          </div>

          <div class="feature-row">
            <i class="fas fa-hand-pointer"></i>
            <div>
              <h3 style="color:var(--neon-purple);">Pro Editor</h3>
              <p style="color:#aaa;">Zoom, Pan & Redact.</p>
            </div>
          </div>
        </div>
      </div>

      <button id="startBtn" class="btn" onclick="goToScreen('screen-select')">START</button>
    </div>

    <div id="screen-select" class="screen">
      <div class="header">
        <h2 style="font-family:'Rubik Glitch'; color:#fff;">UPLOAD ID</h2>
      </div>

      <div style="flex:1; display:flex; flex-direction:column; justify-content:center;">
        <div class="grid">
          <div class="option" onclick="triggerUpload()"><i class="far fa-id-card"></i><div>ID CARD</div></div>
          <div class="option" onclick="triggerUpload()"><i class="fas fa-passport"></i><div>PASSPORT</div></div>
        </div>
      </div>

      <input type="file" id="fileInput" accept="image/*" capture="environment" onchange="handleImage(this)" style="display:none;">
    </div>

    <div id="screen-edit" class="screen">
      <div style="text-align:center; margin-bottom: 5px;">
        <span style="color:var(--neon-green); font-family:'Share Tech Mono';">SECURE EDITOR ACTIVE</span>
      </div>

      <div id="editor-wrapper">
        <canvas id="canvas"></canvas>

        <div id="tutorial-overlay" onclick="closeTutorial()">
          <div class="tut-card">
            <h3 style="color:#fff; margin-bottom:20px;">CONTROLS</h3>
            <div class="tut-row">
              <div class="tut-icon">üëÜ</div>
              <div><strong style="color:var(--neon-green)">ONE FINGER</strong><br><span style="color:#aaa; font-size:12px;">Draw Black Line</span></div>
            </div>
            <div class="tut-row">
              <div class="tut-icon">‚úåÔ∏è</div>
              <div><strong style="color:var(--neon-purple)">TWO FINGERS</strong><br><span style="color:#aaa; font-size:12px;">Pinch to Zoom / Move</span></div>
            </div>
            <button class="btn" style="font-size:16px; padding:10px;">GOT IT</button>
          </div>
        </div>

        <div class="zoom-controls">
          <div class="zoom-circle" onclick="zoomIn()"><i class="fas fa-plus"></i></div>
          <div class="zoom-circle" onclick="zoomOut()"><i class="fas fa-minus"></i></div>
        </div>
      </div>

      <div class="toolbar-main">
        <div class="tool-btn" onclick="setBrush(10, this)">
          <i class="fas fa-circle" style="font-size:8px;"></i>
          <span>SMALL</span>
        </div>
        <div class="tool-btn active" onclick="setBrush(30, this)">
          <i class="fas fa-circle" style="font-size:14px;"></i>
          <span>MED</span>
        </div>
        <div class="tool-btn" onclick="setBrush(60, this)">
          <i class="fas fa-circle" style="font-size:20px;"></i>
          <span>LARGE</span>
        </div>
        <div class="tool-btn" onclick="undoLast()">
          <i class="fas fa-undo"></i>
          <span>UNDO</span>
        </div>
        <div class="tool-btn" onclick="rotateImage()">
          <i class="fas fa-redo"></i>
          <span>TURN</span>
        </div>
      </div>

      <button id="submitBtn" class="btn" onclick="finishVerification()">UPLOAD SECURELY</button>
    </div>

    <div id="screen-success" class="screen" style="justify-content:center; align-items:center; text-align:center;">
      <i class="fas fa-check-circle" style="font-size: 80px; color: var(--neon-green); margin-bottom:20px;"></i>
      <h1 style="font-family:'Rubik Glitch';">SENT!</h1>
      <p id="success-msg" style="color:#aaa;">Verification Pending...</p>
      <button class="btn" onclick="location.reload()" style="margin-top:40px; background:transparent; border:1px solid #333;">NEW UPLOAD</button>
    </div>
  </div>

  <script>
    let VERIFY_TOKEN = null;

    const img = new Image();
    let strokes = [];
    let currentStroke = [];
    let view = { x: 0, y: 0, scale: 1 };
    let brushSize = 30;
    let currentRotation = 0;

    let isDrawing = false;
    let isPinching = false;
    let lastDist = 0;
    let lastTouch = { x:0, y:0 };

    let faceModel = null;
    let scanTimer = null;
    let aiResult = "SKIPPED";

    let editorListenersBound = false;
    let lastObjectUrl = null;

    // For modal flow
    let pendingContinue = null;

    function showModal({ title, text, reason }) {
      document.getElementById("modal-title").innerText = title || "‚ö†Ô∏è Possible Non-ID Image";
      document.getElementById("modal-text").innerText = text || "This photo doesn‚Äôt look like an ID card.";
      document.getElementById("modal-reason").innerText = "Reason: " + (reason || "UNKNOWN");
      document.getElementById("modal-overlay").style.display = "flex";
    }
    function hideModal() {
      document.getElementById("modal-overlay").style.display = "none";
    }
    function modalRetake() {
      hideModal();
      // go back to select screen
      document.getElementById("loading-overlay").style.display = "none";
      goToScreen("screen-select");
      // reopen file input
      setTimeout(() => document.getElementById("fileInput").click(), 150);
    }
    function modalContinue() {
      hideModal();
      if (typeof pendingContinue === "function") pendingContinue();
      pendingContinue = null;
    }

    window.onload = async () => {
      const params = new URLSearchParams(window.location.search);
      VERIFY_TOKEN = params.get("token");

      if (!VERIFY_TOKEN) {
        document.getElementById("tokenWarning").style.display = "block";
        const startBtn = document.getElementById("startBtn");
        if (startBtn) startBtn.disabled = true;
      }

      try {
        faceModel = await blazeface.load();
        console.log("AI Ready");
      } catch (e) {
        console.log("AI Failed to preload:", e);
      }
    };

    function goToScreen(id) {
      document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }

    function triggerUpload() {
      if (!VERIFY_TOKEN) {
        alert("Invalid link. Please open the verify link from Discord (it must include ?token=).");
        return;
      }
      document.getElementById("fileInput").click();
    }

    function handleImage(input) {
      if (!input.files || !input.files[0]) return;

      const file = input.files[0];
      input.value = "";

      document.getElementById("loading-overlay").style.display = "flex";
      document.getElementById("manual-options").style.display = "none";
      document.getElementById("loading-msg").innerText = "SCANNING...";

      strokes = [];
      currentStroke = [];
      isDrawing = false;
      isPinching = false;
      currentRotation = 0;
      aiResult = "SKIPPED";

      clearTimeout(scanTimer);
      scanTimer = setTimeout(() => {
        document.getElementById("manual-options").style.display = "block";
        document.getElementById("loading-msg").innerText = "TAKING TOO LONG ‚Äî TAP SKIP";
      }, 6000);

      try { if (lastObjectUrl) URL.revokeObjectURL(lastObjectUrl); } catch (_) {}
      lastObjectUrl = URL.createObjectURL(file);

      img.onload = () => {
        const aiCan = document.createElement("canvas");
        const scale = Math.min(1, 500 / img.width);
        aiCan.width = Math.max(1, Math.floor(img.width * scale));
        aiCan.height = Math.max(1, Math.floor(img.height * scale));
        aiCan.getContext("2d").drawImage(img, 0, 0, aiCan.width, aiCan.height);
        runAI(aiCan);
      };

      img.onerror = () => {
        clearTimeout(scanTimer);
        document.getElementById("loading-msg").innerText = "IMAGE LOAD FAILED";
        document.getElementById("manual-options").style.display = "block";
      };

      img.src = lastObjectUrl;
    }

    // ‚úÖ basic ‚ÄúID-ish‚Äù heuristics (lightweight + non-guessy)
    function looksLikeCardByAspect(imgW, imgH) {
      // ID cards are often ~1.58 aspect (credit card). We'll allow a wide window:
      const aspect = imgW / imgH;
      const a = aspect >= 1.15 && aspect <= 2.05; // loose window
      const b = (1/aspect) >= 1.15 && (1/aspect) <= 2.05; // if rotated
      return a || b;
    }

    async function runAI(canvasRef) {
      try {
        if (!faceModel) faceModel = await blazeface.load();

        const preds = await faceModel.estimateFaces(canvasRef, false);
        const hasFace = !!(preds && preds.length > 0);

        // Card-ish heuristic
        const cardish = looksLikeCardByAspect(img.width, img.height);
        const tooSmall = (Math.max(img.width, img.height) < 600);

        if (hasFace) {
          aiResult = "VERIFIED";
          forceEditor();
          return;
        }

        // NO FACE detected -> warn strongly as "not an ID"
        aiResult = "NOT_DETECTED";
        clearTimeout(scanTimer);
        document.getElementById("manual-options").style.display = "block";
        document.getElementById("loading-msg").innerText = "NOT AN ID?";

        pendingContinue = () => forceEditor();

        let reason = "NO_FACE";
        if (!cardish) reason = "NOT_CARD_SHAPE";
        if (tooSmall) reason = "TOO_SMALL";

        showModal({
          title: "‚ö†Ô∏è This doesn‚Äôt look like an ID",
          text:
            "We couldn‚Äôt detect an ID-style photo.\n\n" +
            "‚úÖ Retake with your ID filling the frame.\n" +
            "‚úÖ Good lighting, readable text.\n" +
            "‚úÖ Avoid random objects / product photos.\n\n" +
            "You can still continue, but staff may deny it.",
          reason
        });

      } catch (e) {
        aiResult = "AI_FAILED";
        clearTimeout(scanTimer);
        document.getElementById("manual-options").style.display = "block";
        document.getElementById("loading-msg").innerText = "AI FAILED ‚Äî TAP SKIP IF YOU WANT";
        console.log("AI error:", e);
      }
    }

    function forceEditor() {
      clearTimeout(scanTimer);
      document.getElementById("loading-overlay").style.display = "none";
      goToScreen("screen-edit");

      const wrapper = document.getElementById("editor-wrapper");
      const canvas = document.getElementById("canvas");

      const dpr = window.devicePixelRatio || 1;
      canvas.width = Math.max(1, Math.floor(wrapper.clientWidth * dpr));
      canvas.height = Math.max(1, Math.floor(wrapper.clientHeight * dpr));

      const ratio = Math.min(canvas.width / img.width, canvas.height / img.height);
      const s = ratio * 0.9;

      view = {
        scale: s,
        x: (canvas.width - img.width * s) / 2,
        y: (canvas.height - img.height * s) / 2
      };

      bindEditorListeners();
      document.getElementById("tutorial-overlay").style.display = "flex";
      render();
    }

    function closeTutorial() {
      document.getElementById("tutorial-overlay").style.display = "none";
    }

    function bindEditorListeners() {
      if (editorListenersBound) return;
      editorListenersBound = true;

      const canvasEl = document.getElementById("canvas");

      function toWorld(tx, ty) {
        const dpr = window.devicePixelRatio || 1;
        let x = (tx * dpr - view.x) / view.scale;
        let y = (ty * dpr - view.y) / view.scale;

        const cx = img.width / 2, cy = img.height / 2;
        const rad = -currentRotation * Math.PI / 180;
        const dx = x - cx, dy = y - cy;

        return {
          x: cx + dx * Math.cos(rad) - dy * Math.sin(rad),
          y: cy + dx * Math.sin(rad) + dy * Math.cos(rad)
        };
      }

      canvasEl.addEventListener("touchstart", (e) => {
        e.preventDefault();

        if (e.touches.length === 2) {
          isPinching = true;
          isDrawing = false;
          currentStroke = [];

          lastDist = Math.hypot(
            e.touches[0].clientX - e.touches[1].clientX,
            e.touches[0].clientY - e.touches[1].clientY
          );

          lastTouch = {
            x: (e.touches[0].clientX + e.touches[1].clientX) / 2,
            y: (e.touches[0].clientY + e.touches[1].clientY) / 2
          };
        } else if (e.touches.length === 1 && !isPinching) {
          isDrawing = true;
          const rect = canvasEl.getBoundingClientRect();
          const pt = toWorld(e.touches[0].clientX - rect.left, e.touches[0].clientY - rect.top);
          currentStroke = [pt];
        }
      }, { passive: false });

      canvasEl.addEventListener("touchmove", (e) => {
        e.preventDefault();

        if (isPinching && e.touches.length === 2) {
          const dist = Math.hypot(
            e.touches[0].clientX - e.touches[1].clientX,
            e.touches[0].clientY - e.touches[1].clientY
          );

          const cx = (e.touches[0].clientX + e.touches[1].clientX) / 2;
          const cy = (e.touches[0].clientY + e.touches[1].clientY) / 2;

          const dpr = window.devicePixelRatio || 1;
          view.x += (cx - lastTouch.x) * dpr;
          view.y += (cy - lastTouch.y) * dpr;
          lastTouch = { x: cx, y: cy };

          const delta = dist - lastDist;
          view.scale *= (1 + delta * 0.005);
          lastDist = dist;

          render();
        } else if (isDrawing && e.touches.length === 1) {
          const rect = canvasEl.getBoundingClientRect();
          const pt = toWorld(e.touches[0].clientX - rect.left, e.touches[0].clientY - rect.top);
          currentStroke.push(pt);
          render();
        }
      }, { passive: false });

      canvasEl.addEventListener("touchend", (e) => {
        if (e.touches.length === 0) {
          if (isDrawing && currentStroke.length > 1) {
            strokes.push({ points: currentStroke, size: brushSize });
          }
          isDrawing = false;
          isPinching = false;
          currentStroke = [];
          render();
        }
      }, { passive: false });
    }

    function render() {
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      ctx.save();
      ctx.translate(view.x, view.y);
      ctx.scale(view.scale, view.scale);

      ctx.translate(img.width/2, img.height/2);
      ctx.rotate(currentRotation * Math.PI / 180);
      ctx.translate(-img.width/2, -img.height/2);

      ctx.drawImage(img, 0, 0);

      ctx.lineCap = "round";
      ctx.lineJoin = "round";
      ctx.strokeStyle = "#000";

      function drawStroke(strokeData, width) {
        if (!strokeData.points || strokeData.points.length < 2) return;
        ctx.lineWidth = width;
        ctx.beginPath();
        ctx.moveTo(strokeData.points[0].x, strokeData.points[0].y);
        for (let i=1; i<strokeData.points.length; i++) ctx.lineTo(strokeData.points[i].x, strokeData.points[i].y);
        ctx.stroke();
      }

      strokes.forEach(s => drawStroke(s, s.size));

      if (currentStroke.length > 1) {
        drawStroke({ points: currentStroke }, brushSize);
      }

      ctx.restore();
    }

    function zoomIn() { view.scale *= 1.2; render(); }
    function zoomOut() { view.scale *= 0.8; render(); }
    function rotateImage() { currentRotation = (currentRotation + 90) % 360; render(); }
    function undoLast() { strokes.pop(); render(); }
    function setBrush(s, btn) {
      brushSize = s;
      document.querySelectorAll(".tool-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
    }

    async function canvasToBlob(canvas, mime, quality) {
      return await new Promise((resolve) => {
        canvas.toBlob((b) => resolve(b), mime, quality);
      });
    }

    function fetchWithTimeout(url, opts, ms) {
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), ms || 25000);
      return fetch(url, { ...opts, signal: ctrl.signal })
        .finally(() => clearTimeout(t));
    }

    async function finishVerification() {
      if (!VERIFY_TOKEN) {
        alert("Invalid link. Please open the verification link from Discord again.");
        return;
      }

      if (isDrawing && currentStroke && currentStroke.length > 1) {
        strokes.push({ points: currentStroke, size: brushSize });
        currentStroke = [];
        isDrawing = false;
      }

      const btn = document.getElementById("submitBtn");
      btn.innerHTML = "UPLOADING...";
      btn.disabled = true;

      try {
        const MAX_DIM = 1280;
        const scaleOut = Math.min(1, MAX_DIM / Math.max(img.width, img.height));

        const outCan = document.createElement("canvas");
        outCan.width = Math.max(1, Math.round(img.width * scaleOut));
        outCan.height = Math.max(1, Math.round(img.height * scaleOut));

        const ctx = outCan.getContext("2d");

        ctx.save();
        ctx.scale(scaleOut, scaleOut);

        ctx.translate(img.width / 2, img.height / 2);
        ctx.rotate(currentRotation * Math.PI / 180);
        ctx.translate(-img.width / 2, -img.height / 2);

        ctx.drawImage(img, 0, 0);

        ctx.lineCap = "round";
        ctx.lineJoin = "round";
        ctx.strokeStyle = "#000";

        for (const s of strokes) {
          if (!s?.points || s.points.length < 2) continue;
          ctx.lineWidth = s.size;
          ctx.beginPath();
          ctx.moveTo(s.points[0].x, s.points[0].y);
          for (let i = 1; i < s.points.length; i++) ctx.lineTo(s.points[i].x, s.points[i].y);
          ctx.stroke();
        }

        ctx.restore();

        const MIME = "image/jpeg";
        let QUALITY = 0.85;

        let blob = await canvasToBlob(outCan, MIME, QUALITY);
        if (!blob) throw new Error("Could not create image blob.");

        while (blob.size > 3.8 * 1024 * 1024 && QUALITY > 0.55) {
          QUALITY -= 0.08;
          blob = await canvasToBlob(outCan, MIME, QUALITY);
          if (!blob) break;
        }

        if (!blob) throw new Error("Could not create image blob.");
        if (blob.size > 3.9 * 1024 * 1024) {
          throw new Error("Image still too large. Try again with a smaller photo.");
        }

        const form = new FormData();
        form.append("file", blob, "stoney_verify.jpg");
        form.append("token", VERIFY_TOKEN);
        form.append("status", aiResult);

        const res = await fetchWithTimeout("/api/verify", { method: "POST", body: form }, 25000);

        const raw = await res.text();
        let data = null;
        try { data = JSON.parse(raw); } catch (_) {}

        if (!res.ok) {
          const msg = (data && (data.error || data.details))
            ? `${data.error || "Error"}\n${data.details || ""}`
            : raw;
          throw new Error(msg || `HTTP ${res.status}`);
        }

        if (data && data.success) {
          goToScreen("screen-success");
          return;
        }

        throw new Error((data && data.error) || raw || "Server rejected upload");
      } catch (err) {
        const msg = (err?.name === "AbortError")
          ? "Upload timed out. Check your connection and try again."
          : (err?.message || String(err));

        alert("Upload Error: " + msg);

        btn.disabled = false;
        btn.innerHTML = "UPLOAD SECURELY";
      }
    }
  </script>
</body>
</html>
