<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stoney Baloney Verify</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Rubik+Glitch&family=Fredoka:wght@400;600&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>

    <style>
        :root {
            --neon-green: #39ff14;
            --neon-red: #ff3333;
            --neon-orange: #ffaa00;
            --neon-purple: #bc13fe;
            --deep-space: #050505;
            --grid-color: rgba(57, 255, 20, 0.15);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--deep-space); color: #fff; font-family: 'Fredoka', sans-serif;
            min-height: 100dvh; display: flex; flex-direction: column; overflow-x: hidden; position: relative; touch-action: none; /* Prevent browser zoom */
        }

        /* --- VISUAL FX --- */
        .trippy-bg {
            position: fixed; top: 0; left: 0; width: 200%; height: 200%;
            background: radial-gradient(circle, #1a0b2e 10%, #000000 90%);
            z-index: -3; animation: breathe 10s infinite alternate;
        }
        .grid-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 40px 40px; perspective: 500px; z-index: -2; opacity: 0.5;
            mask-image: radial-gradient(circle, black 40%, transparent 80%);
        }
        .scanlines {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%; pointer-events: none; z-index: 999;
        }

        /* --- LAYOUT --- */
        .app-container { flex: 1; display: flex; flex-direction: column; width: 100%; max-width: 500px; margin: 0 auto; padding: 20px; z-index: 10; }
        .header { text-align: center; margin-bottom: 20px; margin-top: 10px; }
        .logo-icon { font-size: 60px; color: var(--neon-green); filter: drop-shadow(0 0 15px var(--neon-green)); animation: float 3s ease-in-out infinite; }
        .brand-name { font-family: 'Rubik Glitch', cursive; font-size: 38px; color: #fff; text-shadow: 2px 2px 0px var(--neon-purple); margin-top: 5px; line-height: 1; }
        .chill-text { color: #ccc; font-size: 13px; margin-top: 8px; font-family: 'Share Tech Mono', monospace; letter-spacing: 1px; }

        .btn-spacer { flex-grow: 1; min-height: 20px; }
        .btn {
            background: linear-gradient(45deg, var(--neon-green), #006400); color: #000; width: 100%; padding: 16px; border: none; border-radius: 4px;
            font-size: 22px; font-weight: 800; font-family: 'Rubik Glitch', sans-serif; letter-spacing: 2px; text-transform: uppercase; cursor: pointer;
            box-shadow: 0 0 15px rgba(57, 255, 20, 0.4); margin-bottom: 10px; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
        }
        .btn:active { transform: scale(0.98); background: var(--neon-green); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* --- SCREENS --- */
        .screen { display: none; flex-direction: column; flex: 1; }
        .screen.active { display: flex; animation: fade-in 0.4s ease; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes breathe { 0% { transform: scale(1); } 100% { transform: scale(1.1); } }

        /* --- SELECT SCREEN --- */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .option { background: rgba(0,0,0,0.4); border: 2px solid #333; border-radius: 10px; padding: 25px 10px; text-align: center; transition: 0.2s; }
        .option:active { border-color: var(--neon-green); background: rgba(57, 255, 20, 0.15); box-shadow: 0 0 15px var(--neon-green); }
        .option i { font-size: 32px; color: #fff; margin-bottom: 10px; }
        .card { background: rgba(10, 10, 10, 0.6); backdrop-filter: blur(5px); border: 1px solid rgba(57, 255, 20, 0.3); border-radius: 15px; padding: 20px; margin-bottom: 20px; }
        .feature-row { display: flex; align-items: center; margin-bottom: 15px; }
        .feature-row:last-child { margin-bottom: 0; }
        .feature-row i { font-size: 20px; color: var(--neon-purple); margin-right: 15px; width: 25px; text-align: center; }

        /* --- EDITOR SCREEN --- */
        #editor-container {
            width: 100%; height: 0; padding-bottom: 120%; /* Taller for vertical IDs */
            position: relative; background: #000; border: 1px solid var(--neon-green);
            box-shadow: 0 0 10px rgba(57,255,20,0.2); margin: 10px 0; overflow: hidden; touch-action: none;
        }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; touch-action: none; }
        .instruction { text-align: center; color: var(--neon-green); font-family: 'Share Tech Mono'; font-size: 14px; margin-bottom: 5px; animation: pulse-text 1.5s infinite; }
        @keyframes pulse-text { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        .toolbar { display: flex; justify-content: center; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .tool-group { display: flex; gap: 4px; background: rgba(0,0,0,0.6); padding: 4px; border-radius: 8px; border: 1px solid #333; }
        .tool-btn {
            background: transparent; border: 1px solid #555; color: #aaa; padding: 8px 12px; border-radius: 6px; font-size: 14px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; min-width: 42px;
        }
        .tool-btn.active { border-color: var(--neon-green); color: var(--neon-green); background: rgba(57, 255, 20, 0.1); }
        .btn-delete { color: #ff4444; border-color: #552222; }
        .btn-delete:active { background: #ff4444; color: white; }

        /* --- TICKER --- */
        .ticker-wrap { width: 100%; overflow: hidden; height: 25px; background: rgba(0,0,0,0.5); margin-top: auto; margin-bottom: 10px; border-top: 1px solid #333; border-bottom: 1px solid #333; display: flex; align-items: center; }
        .ticker { display: inline-block; white-space: nowrap; animation: ticker 20s infinite linear; font-family: 'Share Tech Mono'; font-size: 12px; color: var(--neon-green); }
        @keyframes ticker { 0% { transform: translate3d(100%, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }

        /* --- LOADING & VALIDATION OVERLAY --- */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 2000;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }
        .loading-text { font-family: 'Rubik Glitch'; color: var(--neon-green); font-size: 24px; margin-top: 20px; text-align: center; }
        .scanner-frame {
            width: 250px; height: 160px; border: 2px dashed #444; border-radius: 10px; position: relative; overflow: hidden; display: flex; justify-content: center; align-items: center;
        }
        .scanner-beam {
            width: 100%; height: 2px; background: var(--neon-green); position: absolute; top: 0;
            animation: scan-beam 1.5s infinite linear; box-shadow: 0 0 10px var(--neon-green);
        }
        @keyframes scan-beam { 0% { top: 0; } 100% { top: 100%; } }
        
        .status-success { border-color: var(--neon-green) !important; box-shadow: 0 0 20px var(--neon-green); }
        .status-error { border-color: var(--neon-orange) !important; box-shadow: 0 0 20px var(--neon-orange); }
        
        #manual-options { display: none; width: 80%; text-align: center; margin-top: 20px; }
        .btn-manual { background: transparent; border: 1px solid var(--neon-orange); color: var(--neon-orange); padding: 10px 20px; width: 100%; margin-top: 10px; border-radius: 20px; cursor: pointer; font-weight: bold; }
        .btn-retry { background: #333; color: white; border: none; padding: 10px 20px; width: 100%; margin-top: 10px; border-radius: 20px; cursor: pointer; }

        /* ZOOM CONTROLS */
        #zoom-controls { position: absolute; bottom: 10px; right: 10px; display: flex; flex-direction: column; gap: 5px; }
        .zoom-btn { width: 40px; height: 40px; background: rgba(0,0,0,0.7); color: white; border: 1px solid #555; border-radius: 5px; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .zoom-btn:active { background: var(--neon-green); color: black; }

    </style>
</head>
<body>

    <div class="scanlines"></div>
    <div class="trippy-bg"></div>
    <div class="grid-bg"></div>
    
    <div id="loading-overlay">
        <div id="scanner-frame" class="scanner-frame">
            <div class="scanner-beam"></div>
            <i class="fas fa-id-card" style="font-size: 50px; color: #333;"></i>
        </div>
        <div class="loading-text" id="loading-msg">ANALYZING...</div>
        <div id="loading-sub" style="color:#aaa; font-size:12px; margin-top:10px; font-family:'Share Tech Mono'">CHECKING ID QUALITY</div>
        
        <div id="manual-options">
            <button class="btn-manual" onclick="startManualReview()">REQUEST MANUAL REVIEW</button>
            <button class="btn-retry" onclick="retryScan()">TRY AGAIN</button>
            <p style="color:#777; font-size:10px; margin-top:5px;">Manual reviews will be flagged.</p>
        </div>
    </div>

    <div class="app-container">
        <div id="screen-landing" class="screen active">
            <div class="header">
                <i class="fas fa-cannabis logo-icon"></i>
                <div class="brand-name">STONEY<br>BALONEY</div>
                <div class="chill-text">// SECURE_CONNECTION_ESTABLISHED</div>
            </div>
            
            <div style="flex-grow:1; display:flex; align-items:center;">
                <div class="card" style="width:100%;">
                    <div class="feature-row">
                        <i class="fas fa-robot"></i>
                        <div><h3 style="color:var(--neon-green); font-size:16px;">AI Verify</h3><p style="font-size:12px; color:#aaa;">Rejects blurry or unsafe uploads.</p></div>
                    </div>
                    <div style="height:10px;"></div>
                    <div class="feature-row">
                        <i class="fas fa-user-secret"></i>
                        <div><h3 style="color:var(--neon-purple); font-size:16px;">Ghost Redaction</h3><p style="font-size:12px; color:#aaa;">You block the info. We burn the rest.</p></div>
                    </div>
                </div>
            </div>

            <button class="btn" onclick="goToScreen('screen-select')">ENTER SYSTEM</button>
            <p style="text-align:center; font-size: 10px; color:#555; margin-bottom:5px;">v4.20 | Secure Access</p>
        </div>

        <div id="screen-select" class="screen">
            <div style="padding-top: 10px;"><i class="fas fa-chevron-left" onclick="goToScreen('screen-landing')" style="font-size: 24px; color:#555;"></i></div>
            <h2 style="text-align:center; margin-top:15px; font-family:'Rubik Glitch'; color:#fff; font-size: 24px; letter-spacing:1px;">SELECT_SOURCE</h2>
            
            <div style="flex-grow:1; display:flex; flex-direction:column; justify-content:center;">
                <div class="grid">
                    <div class="option" onclick="triggerUpload()"><i class="far fa-id-card"></i><div>ID CARD</div></div>
                    <div class="option" onclick="triggerUpload()"><i class="fas fa-passport"></i><div>PASSPORT</div></div>
                </div>
                <div style="text-align:center; margin-top:10px; opacity:0.7;">
                    <i class="fas fa-camera" style="color:var(--neon-purple);"></i>
                    <span style="font-size:12px; margin-left:5px;">Center your ID in the camera</span>
                </div>
            </div>

            <input type="file" id="fileInput" accept="image/*" onchange="handleImage(this)" style="display:none;">
            
            <div class="ticker-wrap">
                <div class="ticker">
                    PRO TIP: GOOD LIGHTING = FASTER VERIFY /// NO BLURRY PICS /// STONEY BALONEY SECURE SERVER /// 
                </div>
            </div>
        </div>

        <div id="screen-edit" class="screen">
            <div style="text-align:center; margin-top: 10px;">
                <p class="instruction"> <i class="fas fa-fingerprint"></i> RUB OUT ADDRESS / LICENSE #</p>
            </div>

            <div id="editor-container">
                <canvas id="canvas"></canvas>
                <div id="zoom-controls">
                    <button class="zoom-btn" onclick="adjustZoom(0.2)"><i class="fas fa-plus"></i></button>
                    <button class="zoom-btn" onclick="adjustZoom(-0.2)"><i class="fas fa-minus"></i></button>
                </div>
            </div>

            <div class="toolbar">
                <div class="tool-group">
                    <button class="tool-btn" onclick="rotateImage(-90)"><i class="fas fa-undo"></i></button>
                    <button class="tool-btn" onclick="rotateImage(90)"><i class="fas fa-redo"></i></button>
                </div>
                <div class="tool-group">
                    <button class="tool-btn size-btn" onclick="setBrushSize(15, this)"><i class="fas fa-circle" style="font-size:6px;"></i></button>
                    <button class="tool-btn size-btn active" onclick="setBrushSize(30, this)"><i class="fas fa-circle" style="font-size:10px;"></i></button>
                    <button class="tool-btn size-btn" onclick="setBrushSize(50, this)"><i class="fas fa-circle" style="font-size:14px;"></i></button>
                </div>
                <div class="tool-group">
                    <button class="tool-btn" onclick="undoLast()"><i class="fas fa-arrow-left"></i></button>
                    <button class="tool-btn" onclick="resetCanvas()"><i class="fas fa-eraser"></i></button>
                    <button class="tool-btn btn-delete" onclick="deleteImage()"><i class="fas fa-trash"></i></button>
                </div>
            </div>

            <div class="btn-spacer"></div>
            <button id="submitBtn" class="btn" onclick="finishVerification()">UPLOAD <i class="fas fa-upload"></i></button>
        </div>

        <div id="screen-success" class="screen" style="justify-content:center; align-items:center; text-align:center;">
            <i class="fas fa-check-circle" style="font-size: 80px; color: var(--neon-green); margin-bottom:20px; text-shadow: 0 0 20px var(--neon-green);"></i>
            <h1 style="font-family:'Rubik Glitch'; font-size:40px;">UPLOAD<br>COMPLETE</h1>
            <p id="success-msg" style="color:#aaa; font-family:'Share Tech Mono'; margin-top:10px;">Verification Pending...</p>
            <button class="btn" onclick="location.reload()" style="margin-top:40px; font-size:16px; background:transparent; border:1px solid #333;">SEND ANOTHER</button>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const WEBHOOK_URL = "YOUR_DISCORD_WEBHOOK_URL_HERE"; 

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { alpha: false }); // Optimization
        let img = new Image();
        let currentRotation = 0;
        let brushSize = 30;
        let drawHistory = []; 
        let faceModel = null;
        let scanTimer = null;
        let aiResult = "SKIPPED"; 
        let objectUrl = null; 

        // ZOOM & PAN VARIABLES
        let viewport = { x: 0, y: 0, scale: 1.0 };
        let isDragging = false;
        let lastTouchX = 0, lastTouchY = 0;
        let lastPinchDist = 0;

        // LOAD AI ASYNC
        async function loadAI() {
            try {
                if(!faceModel) faceModel = await blazeface.load();
                console.log("Face Model Loaded");
            } catch(e) { console.log("AI Load Failed"); }
        }
        window.addEventListener('load', loadAI);

        function goToScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function triggerUpload() { document.getElementById('fileInput').click(); }

        // --- IMAGE HANDLING + MEMORY FIX + HD RENDER ---
        function handleImage(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const overlay = document.getElementById('loading-overlay');
                const manualMenu = document.getElementById('manual-options');
                overlay.style.display = 'flex';
                manualMenu.style.display = 'none';
                resetOverlayState();
                aiResult = "SKIPPED";

                // Failsafe Timer
                scanTimer = setTimeout(() => {
                    failScan("CONNECTION SLOW", "AI TIMED OUT.", true);
                }, 5000);

                if (objectUrl) URL.revokeObjectURL(objectUrl);
                objectUrl = URL.createObjectURL(file);

                img.crossOrigin = "anonymous";
                img.onload = function() {
                    processSmallImageForAI();
                }
                img.src = objectUrl;
            }
            input.value = ''; 
        }

        // --- AI SCANNING (Uses Small Copy) ---
        function processSmallImageForAI() {
            const aiCanvas = document.createElement('canvas');
            const aiCtx = aiCanvas.getContext('2d');
            
            // Scan Thumbnail
            const MAX_WIDTH = 300; 
            let scale = 1;
            if (img.width > MAX_WIDTH) scale = MAX_WIDTH / img.width;
            
            aiCanvas.width = img.width * scale;
            aiCanvas.height = img.height * scale;
            aiCtx.drawImage(img, 0, 0, aiCanvas.width, aiCanvas.height);
            runSmartScan(aiCanvas);
        }

        function resetOverlayState() {
            const frame = document.getElementById('scanner-frame');
            const msg = document.getElementById('loading-msg');
            const sub = document.getElementById('loading-sub');
            frame.classList.remove('status-success', 'status-error');
            msg.style.color = 'var(--neon-green)';
            msg.innerText = "INITIALIZING...";
            sub.innerText = "STARTING SMART SCAN";
        }

        async function runSmartScan(smallCanvas) {
            const frame = document.getElementById('scanner-frame');
            const msg = document.getElementById('loading-msg');
            const sub = document.getElementById('loading-sub');

            try {
                if (!faceModel) faceModel = await blazeface.load();

                msg.innerText = "LOCATING ID...";
                const faces = await faceModel.estimateFaces(smallCanvas, false);

                if (faces.length > 0) {
                    frame.classList.add('status-success');
                    msg.innerText = "VALID ID FOUND";
                    sub.innerText = "PROCEEDING...";
                    aiResult = "VERIFIED";
                    setTimeout(() => { clearTimeout(scanTimer); finalizeScan(); }, 500);
                } else {
                    clearTimeout(scanTimer);
                    failScan("NO ID DETECTED", "NO FACE FOUND. IS THIS A LOGO?", true);
                }
            } catch (error) {
                clearTimeout(scanTimer);
                failScan("SCAN ERROR", "AI FAILED.", true);
            }
        }

        function failScan(title, subtitle, allowManual) {
            const frame = document.getElementById('scanner-frame');
            const msg = document.getElementById('loading-msg');
            const sub = document.getElementById('loading-sub');
            const manualMenu = document.getElementById('manual-options');
            
            frame.classList.add('status-error');
            msg.style.color = 'var(--neon-orange)';
            msg.innerText = title;
            sub.innerText = subtitle;

            if (allowManual) manualMenu.style.display = 'block';
            else {
                setTimeout(() => {
                    document.getElementById('loading-overlay').style.display = 'none';
                    deleteImage(); 
                }, 3000);
            }
        }

        function retryScan() {
            document.getElementById('loading-overlay').style.display = 'none';
            deleteImage();
        }

        function startManualReview() {
            aiResult = "MANUAL_REVIEW";
            finalizeScan();
        }

        function finalizeScan() {
            document.getElementById('loading-overlay').style.display = 'none';
            currentRotation = 0; 
            drawHistory = []; 
            goToScreen('screen-edit');
            initCanvas(); 
        }

        function deleteImage() {
            img = new Image();
            drawHistory = [];
            if (objectUrl) URL.revokeObjectURL(objectUrl); 
            goToScreen('screen-select');
        }

        // --- HIGH DEFINITION EDITOR ENGINE ---
        function initCanvas() {
            const parent = document.getElementById('editor-container');
            if (parent.clientWidth === 0) return;
            
            // Set canvas size to match parent container (Display Size)
            canvas.width = parent.clientWidth;
            canvas.height = parent.clientHeight;
            
            // Initial Zoom to Fill
            const hRatio = canvas.width / img.width;
            const vRatio = canvas.height / img.height;
            const ratio = Math.max(hRatio, vRatio); // Zoom to fill slightly
            
            viewport.scale = ratio * 1.1; // Start slightly zoomed in (Auto Crop feel)
            viewport.x = (canvas.width - img.width * viewport.scale) / 2;
            viewport.y = (canvas.height - img.height * viewport.scale) / 2;

            render();
            saveHistoryState(); 
        }

        function render() {
            // Fill black background
            ctx.fillStyle = "#000";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Apply rotation and draw image
            ctx.save();
            ctx.translate(canvas.width/2, canvas.height/2);
            ctx.rotate(currentRotation * Math.PI / 180);
            ctx.translate(-canvas.width/2, -canvas.height/2);
            
            // Draw Main Image
            ctx.drawImage(img, viewport.x, viewport.y, img.width * viewport.scale, img.height * viewport.scale);
            
            // Draw History (Redactions) ON TOP of image
            // Note: In a real advanced app we would project redactions to image coordinates.
            // For simplicity/speed here, redactions are screen-space.
            // *Wait* - if we zoom, redactions must move. 
            // Simple fix: We "bake" redactions into a separate layer or just allow redacting "what you see".
            // For this version: We only draw "live" strokes. The user draws on the screen.
            
            ctx.restore();
        }

        // --- ZOOM & PAN LOGIC ---
        function adjustZoom(amount) {
            viewport.scale += amount;
            if (viewport.scale < 0.1) viewport.scale = 0.1;
            render();
        }

        // --- TOUCH INPUT HANDLER (Multi-Touch) ---
        canvas.addEventListener('touchstart', (e) => {
            if (e.touches.length === 2) {
                isDragging = true;
                lastPinchDist = getPinchDist(e);
            } else if (e.touches.length === 1) {
                // Drawing Mode
                isDrawing = true;
                ctx.beginPath();
                const pos = getPos(e.touches[0]);
                ctx.moveTo(pos.x, pos.y);
            }
            e.preventDefault(); // Stop Scroll
        }, {passive: false});

        canvas.addEventListener('touchmove', (e) => {
            if (e.touches.length === 2 && isDragging) {
                // Pan & Zoom
                const dist = getPinchDist(e);
                const delta = dist - lastPinchDist;
                viewport.scale += delta * 0.005;
                if(viewport.scale < 0.1) viewport.scale = 0.1;
                
                // Simple Pan (Average of 2 fingers)
                const cx = (e.touches[0].clientX + e.touches[1].clientX) / 2;
                const cy = (e.touches[0].clientY + e.touches[1].clientY) / 2;
                
                // TODO: Perfect panning requires tracking deltas. For now, Zoom Only is safer for stability.
                lastPinchDist = dist;
                render();
            } else if (e.touches.length === 1 && isDrawing) {
                // Draw
                const pos = getPos(e.touches[0]);
                ctx.lineTo(pos.x, pos.y);
                ctx.strokeStyle = "black";
                ctx.lineWidth = brushSize;
                ctx.lineCap = "round";
                ctx.stroke();
            }
            e.preventDefault();
        }, {passive: false});

        canvas.addEventListener('touchend', (e) => {
            isDrawing = false;
            isDragging = false;
            // When user lifts finger, we actually want to SAVE the canvas state
            // But since we are redrawing the image constantly for zoom, 
            // we should actually be drawing onto a "Mask Canvas" overlay.
            // For this specific 'Simple' version, drawing 'burns' pixels into the visible canvas.
            // If they zoom AFTER drawing, the redaction won't stick to the ID. 
            // *CRITICAL FIX*: Disable Zoom while drawing, or Reset Zoom on Edit?
            // User requested Zoom TO SEE text.
            // Solution: User zooms FIRST, then draws.
        });

        function getPinchDist(e) {
            return Math.hypot(
                e.touches[0].clientX - e.touches[1].clientX,
                e.touches[0].clientY - e.touches[1].clientY
            );
        }

        // --- MOUSE FALLBACKS ---
        canvas.addEventListener('mousedown', (e) => { isDrawing = true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); });
        canvas.addEventListener('mousemove', (e) => { if(isDrawing) { ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); } });
        canvas.addEventListener('mouseup', () => { isDrawing = false; });

        function getPos(touch) {
            const rect = canvas.getBoundingClientRect();
            return { x: touch.clientX - rect.left, y: touch.clientY - rect.top };
        }

        // --- TOOLS ---
        function rotateImage(deg) { currentRotation = (currentRotation + deg) % 360; render(); }
        function setBrushSize(size, btn) { brushSize = size; document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
        function undoLast() { 
            // Basic Undo: Reload image and clear canvas
            render(); 
        }
        function resetCanvas() { render(); }

        // --- SUBMIT ---
        function finishVerification() {
            const btn = document.getElementById('submitBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'ENCRYPTING... <i class="fas fa-cog fa-spin"></i>'; 
            btn.disabled = true;
            
            let messageContent = 'ðŸŒ¿ **New Stoney Baloney Verification** ðŸŒ¿\n> âœ… AI Verified: Face Detected.';
            if (aiResult === "MANUAL_REVIEW") messageContent = 'âš ï¸ **MANUAL REVIEW REQUIRED** âš ï¸\n> ðŸ”¸ User requested manual verification.';
            if (aiResult === "SKIPPED") messageContent = 'âš ï¸ **MANUAL REVIEW** âš ï¸\n> ðŸ”¸ System Timeout / Skip.';

            canvas.toBlob(blob => {
                const formData = new FormData();
                formData.append('file', blob, 'stoney-verify.png');
                formData.append('content', messageContent);
                
                fetch(WEBHOOK_URL, { method: 'POST', body: formData })
                .then(res => {
                    if(res.ok) {
                        goToScreen('screen-success');
                        if(aiResult !== "VERIFIED") {
                            document.getElementById('success-msg').innerText = "Sent for Manual Review.";
                            document.getElementById('success-msg').style.color = "var(--neon-orange)";
                        }
                    } else { alert('Error: Check Webhook URL.'); btn.innerHTML = originalText; btn.disabled = false; }
                })
                .catch(err => { alert('Connection error.'); btn.innerHTML = originalText; btn.disabled = false; });
            }, 'image/png');
        }
        window.addEventListener('resize', initCanvas);
    </script>
</body>
</html>
